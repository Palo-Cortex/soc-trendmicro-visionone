commonfields:
  id: TrendMicroMitreBlockXSIAM
  version: -1
name: TrendMicroMitreBlockXSIAM
comment: MITRE chips for legacy layoutscontainer dynamic sections (reads root or CustomFields).
type: python
tags: [dynamic-section]
enabled: true
fromversion: 6.2.0
marketplaces: [marketplacev2]
args:
  - name: tactic_field
    defaultValue: mitre_tactics
  - name: techniques_field
    defaultValue: mitre_technique_ids
script: |-
  import json
  from html import escape

  def get_val(src, key):
    if key in src: return src.get(key)
    cf = src.get('CustomFields') or src.get('customFields') or {}
    return cf.get(key)

  def norm(x):
    if not x:
      return []
    if isinstance(x, list):
      return [str(i).strip() for i in x if str(i).strip()]
    if isinstance(x, str):
      s = x.strip()
      if not s: return []
      try:
        obj=json.loads(s)
        if isinstance(obj, list):
          return [str(i).strip() for i in obj if str(i).strip()]
      except Exception:
        pass
      for d in [',',';','|','\n','\t',' ']:
        if d in s:
          return [i.strip() for i in s.split(d) if i.strip()]
      return [s]
    return [str(x)]

  def pill(items):
    if not items:
      return "<i>No data</i>"
    return "".join([
      f"<span style='display:inline-block;border:1px solid #aaa;border-radius:10px;padding:2px 8px;margin:2px'>{escape(i)}</span>"
      for i in items
    ])

  def main():
    inc = demisto.incidents()[0]
    args = demisto.args()
    tactics = norm(get_val(inc, args.get('tactic_field','mitre_tactics')))
    techs   = norm(get_val(inc, args.get('techniques_field','mitre_technique_ids')))

    html = f"<div><h4>MITRE Tactics</h4>{pill(tactics)}</div><div style='margin-top:8px'><h4>Techniques</h4>{pill(techs)}</div>"
    demisto.results({'Type': entryTypes['note'], 'ContentsFormat': formats['html'], 'Contents': html})

  if __name__ in ('__main__','__builtin__','builtins'):
    main()
outputs: []
